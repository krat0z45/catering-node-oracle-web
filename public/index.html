<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Catering Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-grid@2.2/css/simple-grid.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f6; margin: 0; }
        .navbar { background-color: #ffffff; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .navbar-links a { color: #333; text-decoration: none; padding: 0 1rem; font-weight: 500; }
        .navbar-user { color: #555; }
        .container { padding: 2rem; max-width: 1200px; margin: auto; }
        .project-card { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.08); transition: transform 0.2s; display: block; color: inherit; text-decoration: none; }
        .project-card:hover { transform: translateY(-5px); }
        .project-card h3 { margin-top: 0; color: #0056b3; }
        .status { padding: 0.3rem 0.6rem; border-radius: 12px; color: white; font-size: 0.8em; text-transform: uppercase; }
        .status-activo { background-color: #28a745; }
        .status-cancelado { background-color: #dc3545; }
        .status-finiquitado { background-color: #17a2b8; }
        .status-en.proceso { background-color: #ffc107; color: #333; }
        #logoutBtn { background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-left: 1rem; }
        .gerente-only, .admin-only { display: none; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="navbar-links">
        <a href="/index.html">Inicio</a>
        <a href="/proyecto.html" class="gerente-only">Crear Proyecto</a>
        <a href="/solicitud.html" class="gerente-only">Ver Solicitudes</a>
        <a href="/admin-gerentes.html" class="admin-only">Panel de Admin</a>
    </div>
    <div class="navbar-user">
        Conectado como: <strong id="userName"></strong> (<em id="userRole"></em>)
        <button id="logoutBtn">Cerrar Sesión</button>
    </div>
</div>

<div class="container">
    <h1>Mis Proyectos</h1>
    <div id="projects-container" class="row">
        <!-- Los proyectos se cargarán aquí dinámicamente -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(sessionStorage.getItem('usuario'));

        if (!user) {
            location.href = '/login.html';
            return;
        }

        document.getElementById('userName').textContent = user.nombre;
        document.getElementById('userRole').textContent = user.rol;

        if (user.rol === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline');
        } else if (user.rol === 'gerente') {
            document.querySelectorAll('.gerente-only').forEach(el => el.style.display = 'inline');
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('usuario');
            location.href = '/login.html';
        });

        loadProjects(user);
    });

    async function loadProjects(user) {
        let url = user.rol === 'general' ? `/api/proyecto/cliente/${user.id}` : '/api/proyecto';

        const container = document.getElementById('projects-container');
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('No se pudieron cargar los proyectos.');
            
            const projects = await res.json();
            container.innerHTML = '';

            if (projects.length === 0) {
                container.innerHTML = '<p>No hay proyectos para mostrar.</p>';
                return;
            }

            projects.forEach(proj => {
                const statusClass = `status-${proj.ESTATUS.toLowerCase().replace(' ','.')}`;
                const card = `
                    <div class="col-4">
                        <a href="/detalle-proyecto.html?id=${proj.ID_PROYECTO}" class="project-card">
                            <h3>${proj.NOMBRE_PROYECTO || 'Proyecto'} #${proj.ID_PROYECTO}</h3>
                            <p><strong>Fecha:</strong> ${new Date(proj.FECHA_EVENTO).toLocaleDateString()}</p>
                            <p><strong>Invitados:</strong> ${proj.NUM_INVITADOS}</p>
                            <p><strong>Salón:</strong> ${proj.NOMBRE_SALON}</p>
                            <p><strong>Estado:</strong> <span class="status ${statusClass}">${proj.ESTATUS}</span></p>
                        </a>
                    </div>
                `;
                container.innerHTML += card;
            });

        } catch (error) {
            container.innerHTML = `<p style="color: red;">${error.message}</p>`;
        }
    }
</script>

</body>
</html>
