<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración - Catering Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f6; margin: 0; }
        .navbar { background: #333; color: white; padding: 1rem; text-align: center; }
        .navbar a { color: white; text-decoration: none; }
        .container { padding: 2rem; max-width: 1000px; margin: auto; }
        .section { background: white; border-radius: 8px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
        h1, h2 { color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        input { width: 100%; padding: 0.5rem; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; padding: 0.6rem 1rem; border-radius: 4px; cursor: pointer; }
        button.success { background-color: #28a745; }
        button.danger { background-color: #dc3545; }
    </style>
</head>
<body>
<div class="navbar"><a href="/index.html">Volver a Página Principal</a></div>
<div class="container" id="admin-panel" style="display:none;">
    <h1>Panel de Administración</h1>

    <!-- Nueva Sección de Solicitudes Pendientes -->
    <div class="section">
        <h2>Solicitudes de Proyecto Pendientes</h2>
        <table id="solicitudes-table">
            <thead><tr><th>ID Proyecto</th><th>Cliente</th><th>Fecha Evento</th><th>Estatus</th><th>Acciones</th></tr></thead>
            <tbody><!-- Se llena dinámicamente --></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Lista de Gerentes</h2>
        <table id="gerentes-table">
            <thead><tr><th>ID</th><th>Nombre</th><th>Correo</th><th>Teléfono</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Crear Nuevo Gerente</h2>
        <div class="form-grid">
            <input type="text" id="nombre" placeholder="Nombre Completo">
            <input type="email" id="correo" placeholder="Correo Electrónico">
            <input type="tel" id="telefono" placeholder="Teléfono">
            <input type="password" id="contrasena" placeholder="Contraseña">
        </div>
        <button onclick="crearGerente()" style="margin-top: 1rem;">Crear Gerente</button>
        <p id="msg-crear" style="margin-top: 1rem;"></p>
    </div>
</div>

<script>
    const user = JSON.parse(sessionStorage.getItem('usuario'));

    document.addEventListener('DOMContentLoaded', () => {
        if (!user || user.rol !== 'admin') {
            document.body.innerHTML = '<h1>Acceso Denegado</h1><p>Debes ser administrador para ver esta página. <a href="/login.html">Inicia sesión</a></p>';
            return;
        }
        document.getElementById('admin-panel').style.display = 'block';
        loadSolicitudes();
        loadGerentes();
    });

    async function loadSolicitudes() {
        const tbody = document.querySelector('#solicitudes-table tbody');
        try {
            const res = await fetch('/api/proyecto/solicitudes');
            const solicitudes = await res.json();
            tbody.innerHTML = '';
            if (solicitudes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay solicitudes pendientes.</td></tr>';
            }
            solicitudes.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td>${s.ID_PROYECTO}</td>
                        <td>${s.CLIENTE_NOMBRE}</td>
                        <td>${s.FECHA_EVENTO}</td>
                        <td>${s.ESTATUS}</td>
                        <td>
                            <button class="success" onclick="aceptarSolicitud(${s.ID_PROYECTO})">Aceptar</button>
                            <button class="danger" onclick="rechazarSolicitud(${s.ID_PROYECTO})">Rechazar</button>
                        </td>
                    </tr>`;
            });
        } catch (error) { console.error('Error cargando solicitudes:', error); }
    }

    async function aceptarSolicitud(id) {
        await cambiarEstadoSolicitud(id, 'Aceptado');
    }

    async function rechazarSolicitud(id) {
        await cambiarEstadoSolicitud(id, 'Rechazado');
    }

    async function cambiarEstadoSolicitud(id, nuevoEstado) {
        try {
            const res = await fetch(`/api/proyecto/${id}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estatus: nuevoEstado, id_usuario_accion: user.id })
            });
            if (res.ok) {
                alert(`Solicitud ${id} ha sido actualizada a ${nuevoEstado}.`);
                loadSolicitudes(); // Recargar la lista
            } else {
                const data = await res.json();
                alert(`Error al actualizar: ${data.error}`);
            }
        } catch (error) {
            console.error('Error al cambiar estado:', error);
            alert('Error de conexión al actualizar el estado.');
        }
    }

    async function loadGerentes() {
      // ... (código existente sin cambios)
    }

    async function crearGerente() {
      // ... (código existente sin cambios)
    }
</script>
</body>
</html>
