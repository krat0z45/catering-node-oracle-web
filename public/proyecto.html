<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mis Proyectos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }
    .proyecto {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
    }
    .proyecto h3 {
      margin-top: 0;
    }
    .proyecto p {
      margin-bottom: 0.5rem;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
  </style>
</head>
<body>
  <h1>Mis Proyectos</h1>
  <div id="proyectos"></div>

  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Actualizar número de invitados</h2>
      <input type="number" id="numInvitados" />
      <button id="actualizarInvitados">Actualizar</button>
    </div>
  </div>

  <script>
    let currentProjectId = null;

    async function cargarProyectos() {
      const usuario = JSON.parse(sessionStorage.getItem('usuario'));
      if (!usuario) {
        location.href = '/login.html';
        return;
      }

      try {
        const res = await fetch(`/api/proyecto/cliente/${usuario.ID_CLIENTE}`);
        const proyectos = await res.json();
        mostrarProyectos(proyectos);
      } catch (err) {
        console.error("Error cargando proyectos:", err);
      }
    }

    function mostrarProyectos(proyectos) {
      const divProyectos = document.getElementById('proyectos');
      divProyectos.innerHTML = '';
      proyectos.forEach(p => {
        const proyectoDiv = document.createElement('div');
        proyectoDiv.className = 'proyecto';

        const diasRestantes = (new Date(p.FECHA_EVENTO) - new Date()) / (1000 * 60 * 60 * 24);
        const puedeActualizar = diasRestantes >= 5;

        proyectoDiv.innerHTML = `
          <h3>${p.NOMBRE_PROYECTO}</h3>
          <p><strong>Fecha del evento:</strong> ${new Date(p.FECHA_EVENTO).toLocaleDateString()}</p>
          <p><strong>Número de invitados:</strong> ${p.NUM_INVITADOS}</p>
          <p><strong>Salón:</strong> ${p.NOMBRE_SALON}</p>
          <p><strong>Estatus:</strong> ${p.ESTATUS}</p>
          <button onclick="openModal(${p.ID_PROYECTO})" ${!puedeActualizar ? 'disabled' : ''}>Actualizar invitados</button>
        `;
        divProyectos.appendChild(proyectoDiv);
      });
    }

    function openModal(projectId) {
      currentProjectId = projectId;
      document.getElementById('myModal').style.display = 'block';
    }

    document.querySelector('.close').onclick = function() {
      document.getElementById('myModal').style.display = 'none';
    }

    document.getElementById('actualizarInvitados').onclick = async function() {
      const numInvitados = document.getElementById('numInvitados').value;
      try {
        const res = await fetch(`/api/proyecto/${currentProjectId}/invitados`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ num_invitados: numInvitados })
        });
        if (res.ok) {
          location.reload();
        } else {
          alert('Error al actualizar el número de invitados');
        }
      } catch (err) {
        console.error('Error al actualizar invitados:', err);
      }
    }

    cargarProyectos();
  </script>
</body>
</html>
